---
import '../styles/global.css';
import LogoutButton from '../components/islands/LogoutButton';
import DeckManager from '../components/islands/DeckManager';
import DailyStatsWidget from '../components/islands/DailyStatsWidget';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '../components/ui/card';

// Check if user is authenticated
import { createSupabaseServerClient } from '../db/supabase.server';

const supabase = createSupabaseServerClient(Astro.cookies);
const {
  data: { user },
  error,
} = await supabase.auth.getUser();

if (error || !user) {
  return Astro.redirect('/login');
}

// Fetch user's decks with flashcard counts
const { data: decksData } = await supabase
  .from('decks')
  .select(
    `
    *,
    flashcards(count)
  `
  )
  .eq('user_id', user.id)
  .order('created_at', { ascending: false });

// Transform decks to include flashcard count
const decks =
  decksData?.map((deck) => ({
    ...deck,
    flashcardCount:
      Array.isArray(deck.flashcards) && deck.flashcards.length > 0 ? deck.flashcards[0].count : 0,
  })) || [];

const totalDecks = decks.length;

// Fetch user's flashcards
const { data: flashcards } = await supabase.from('flashcards').select('*').eq('user_id', user.id);

const totalFlashcards = flashcards?.length || 0;

// Calculate cards due today
const today = new Date().toISOString();
const dueFlashcards = flashcards?.filter((card) => card.next_review_date <= today) || [];
const cardsDueToday = dueFlashcards.length;
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="viewport" content="width=device-width" />
    <meta name="generator" content={Astro.generator} />
    <title>Dashboard - AI Flashcard App</title>
  </head>
  <body class="min-h-screen bg-background">
    <div class="container mx-auto px-4 py-8 max-w-7xl">
      <!-- Header -->
      <div class="flex justify-between items-center mb-12">
        <h1 class="text-4xl font-bold text-foreground">Dashboard</h1>
        <div class="flex items-center gap-4">
          <span class="text-sm text-muted-foreground">{user.email}</span>
          <LogoutButton client:load />
        </div>
      </div>

      <!-- Welcome Card -->
      <Card className="mb-12 bg-gradient-to-br from-primary/5 to-primary/10 border-primary/20">
        <CardHeader>
          <CardTitle>Welcome to AI Flashcard Learning!</CardTitle>
          <CardDescription>
            Your personalized dashboard for creating and studying flashcards with AI
          </CardDescription>
        </CardHeader>
        <CardContent>
          <p class="text-muted-foreground mb-4">
            ðŸŽ‰ You've successfully logged in! Your authentication system is working perfectly.
          </p>
          <div class="flex gap-3">
            <a href="/create-deck">
              <button
                class="inline-flex items-center justify-center rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:opacity-50 disabled:pointer-events-none ring-offset-background bg-primary text-primary-foreground hover:bg-primary/90 h-10 py-2 px-4"
              >
                âœ¨ Create New Deck
              </button>
            </a>
            <a href="/daily-learning">
              <button
                class="inline-flex items-center justify-center rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:opacity-50 disabled:pointer-events-none ring-offset-background bg-green-600 text-white hover:bg-green-700 h-10 py-2 px-4"
              >
                ðŸ“š Daily Learning
              </button>
            </a>
          </div>
        </CardContent>
      </Card>

      <!-- Quick Stats Grid -->
      <div class="mt-6 grid gap-6 md:grid-cols-3 mb-12">
        <Card className="hover:shadow-lg transition-shadow">
          <CardHeader className="pb-3">
            <CardTitle className="text-base font-medium text-muted-foreground"
              >Total Decks</CardTitle
            >
          </CardHeader>
          <CardContent>
            <p class="text-4xl font-bold text-foreground">{totalDecks}</p>
            <p class="text-sm text-muted-foreground mt-2">
              {
                totalDecks === 0
                  ? 'No decks yet'
                  : `${totalDecks} deck${totalDecks === 1 ? '' : 's'} created`
              }
            </p>
          </CardContent>
        </Card>

        <Card className="hover:shadow-lg transition-shadow">
          <CardHeader className="pb-3">
            <CardTitle className="text-base font-medium text-muted-foreground"
              >Total Flashcards</CardTitle
            >
          </CardHeader>
          <CardContent>
            <p class="text-4xl font-bold text-foreground">{totalFlashcards}</p>
            <p class="text-sm text-muted-foreground mt-2">
              {
                totalFlashcards === 0
                  ? 'Create your first deck'
                  : `${totalFlashcards} card${totalFlashcards === 1 ? '' : 's'} total`
              }
            </p>
          </CardContent>
        </Card>

        <Card className="hover:shadow-lg transition-shadow">
          <CardHeader className="pb-3">
            <CardTitle className="text-base font-medium text-muted-foreground"
              >Cards Due Today</CardTitle
            >
          </CardHeader>
          <CardContent>
            <p class="text-4xl font-bold text-foreground">{cardsDueToday}</p>
            <p class="text-sm text-muted-foreground mt-2">
              {
                cardsDueToday === 0
                  ? 'All caught up! ðŸŽ‰'
                  : `${cardsDueToday} card${cardsDueToday === 1 ? '' : 's'} to review`
              }
            </p>
          </CardContent>
        </Card>
      </div>

      <!-- Daily Learning Stats -->
      <div class="mb-12">
        <h2 class="text-2xl font-bold mb-4">Daily Learning Progress</h2>
        <DailyStatsWidget client:load />
      </div>

      <!-- Your Decks -->
      <div class="space-y-4 mb-3">
        <div class="flex items-center justify-between">
          <h2 class="text-2xl font-bold">Your Decks</h2>
        </div>

        <DeckManager client:load initialDecks={decks} />
      </div>

      <!-- Coming Soon Section -->
      <Card className="mt-12">
        <CardHeader>
          <CardTitle>Coming Soon</CardTitle>
          <CardDescription>Features currently in development</CardDescription>
        </CardHeader>
        <CardContent>
          <ul class="space-y-2 text-muted-foreground">
            <li>âœ¨ AI-powered flashcard generation</li>
            <li>ðŸŽ¯ Spaced repetition review system (SM-2 algorithm)</li>
            <li>ðŸ“Š Study statistics and progress tracking</li>
            <li>ðŸ“¤ Export decks to CSV/JSON</li>
          </ul>
        </CardContent>
      </Card>
    </div>
  </body>
</html>
